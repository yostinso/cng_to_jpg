<!DOCTYPE html>
<html>
    <head>
        <title>National Geographic CNG to JPG converter</title>
        <style>
            #dropzone {
                width: 300px;
                height: 200px;
                border: 2px dashed #ccc;
                border-radius: 10px;
                text-align: center;
                line-height: 200px;
                color: #ccc;
                margin: 20px auto;
            }
            #dropzone.dragover {
                border-color: #000;
                color: #000;
            }
            #instructions {
                width: 40%;
                margin: 20px auto;
            }
            p {
                font: 14px sans-serif;
                margin: 0 0 5px 0;
            }
            #jpegs {
                display: flex;
                flex-wrap: wrap;
                width: 90%;
            }
            #jpegs .div {
                flex: 1;
            }
            #jpegs img {
                margin: 10px;
                height: 400px;
                width: auto;
                border: groove 2px #ccc
            }
            #controls {
                display: none;
                justify-content: center;
            }
            #controls input {
                margin: 30px;
                height: 80px;
                background-color: aquamarine;
                border: outset 8px #8888dd;
                font-weight: bold;
                font-size: 20px;
                box-shadow: 8px 8px 8px #ccc;
                text-shadow: 2px 2px 2px #ccc;
            }
            #controls input:hover {
                border-style: inset;
            }
        </style>
    </head>
    <script type="text/javascript">
        function loadFile(file) {
            return new Promise((resolve, reject) => {
                let fileReader = new FileReader();
                fileReader.addEventListener('loadend', (event) => {
                    resolve({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: new Uint8Array(fileReader.result)
                    });
                });
                fileReader.addEventListener('error', (event) => {
                    reject(event);
                });
                fileReader.addEventListener('abort', (event) => {
                    reject(event);
                });
                fileReader.readAsArrayBuffer(file);
            });
        }
        function xorFile(loadedFile) {
            return {
                ...loadedFile,
                data: loadedFile.data.map((byte) => byte ^ 0xef)
            }
        }
        function processFiles(fileList) {
            return Array.from(fileList).map((file) => {
                var xoredFiles = loadFile(file).then((file) => xorFile(file));
                return xoredFiles.then((xoredFile) => {
                    var jpeg = new Blob([xoredFile.data], {type: xoredFile.type});
                    var jpegUrl = URL.createObjectURL(jpeg);
                    var img = document.createElement('img');
                    img.alt = xoredFile.name;
                    img.src = jpegUrl;
                    return img;
                }).catch((error) => {
                    console.error(error);
                });
            });
        }

        function layoutImages(imgs) {
            var jpegs = document.getElementById('jpegs');
            imgs.forEach((img, i) => {
                var container = document.createElement('div');
                jpegs.appendChild(container);
                container.appendChild(img);
            });
            if (imgs.length > 0) {
                var controls = document.getElementById('controls');
                var downloadButton = document.querySelector('#controls input');
                downloadButton.value = 'Download All ' + imgs.length + ' image(s)';
                controls.style.display = 'flex';
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            var dropzone = document.getElementById('dropzone');

            dropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropzone.classList.add('dragover');
            });

            dropzone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropzone.classList.remove('dragover');
            });

            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropzone.classList.remove('dragover');
                var files = e.dataTransfer.files;
                Promise.all(processFiles(files)).then((imgs) => {
                    layoutImages(imgs);
                });
            });

            var downloadAll = document.getElementById('downloadAll');
            downloadAll.addEventListener('click', function() {
                var imgs = document.querySelectorAll('#jpegs img');
                imgs.forEach((img) => {
                    var a = document.createElement('a');
                    a.href = img.src;
                    a.download = img.alt.replace(/.cng/i, '.jpg');
                    a.click();
                });
            });
        });
    </script>
    <body>
        <div id="dropzone">Drop CNG files here</div>
        <div id="instructions">
            <p>Drag and drop CNG files above to convert them to JPG by XORing every byte with 0xef.</p>
            <p>Files will be downloadable with the same name but with the .jpg extension.</p>
            <p>Credit to <a href="https://www.youtube.com/watch?v=3iDEh3cSqHs">Aging Engineer</a> on
                YouTube for the XOR key.</p>
        </div>
        <div id="controls">
            <input type="button" id="downloadAll" value="Download All">
        </div>
        <div id="jpegs"></div>
    </body>
</html>